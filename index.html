<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在庫管理システム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 1100; display: flex; align-items: center; justify-content: center; }
        #sidebar .nav-link { color: #333; font-size: 1.1rem; padding: 0.75rem 1.5rem; border-left: 3px solid transparent; }
        #sidebar .nav-link.active { color: #0d6efd; font-weight: bold; background-color: #e7f1ff; border-left-color: #0d6efd; }
        #sidebar .nav-link:hover { background-color: #f8f9fa; }
        .header { position: sticky; top: 0; z-index: 1020; }
        .page { display: none; }
        .page.active { display: block; }
        .home-button-wrapper { padding: 2rem; border-radius: 0.5rem; height: 100%; display: grid; align-content: center; justify-content: center; transition: background-color 0.2s ease-in-out; cursor: pointer; }
        .home-button-wrapper:hover { filter: brightness(95%); }
        .home-button { background: transparent; border: none; color: #343a40; font-size: 1.2rem; font-weight: 500; pointer-events: none; }
        .bg-pastel-green { background-color: #c1e1c1; }
        .bg-pastel-orange { background-color: #fde2c1; }
        .bg-pastel-blue { background-color: #c1d5e1; }
        .bg-pastel-purple { background-color: #d1c1e1; }
        .diff-plus { color: #198754; font-weight: bold; }
        .diff-minus { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading" style="display: none;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>

    <!-- Sidebar Navigation (Offcanvas) -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title d-flex align-items-center" id="sidebarLabel">
                <i class="bi bi-paint-bucket fs-2 me-2"></i><span class="fs-4">在庫管理システム</span>
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="nav nav-pills flex-column mb-auto">
                <li class="nav-item"><a href="#" class="nav-link" id="nav-home" onclick="showPage('home')"><i class="bi bi-house-door-fill me-2"></i>ホーム</a></li>
                <li><a href="#" class="nav-link" id="nav-stock" onclick="showPage('stock')"><i class="bi bi-table me-2"></i>在庫一覧</a></li>
                <li><a href="#" class="nav-link" id="nav-incoming" onclick="showPage('incoming')"><i class="bi bi-box-arrow-in-down me-2"></i>入庫登録</a></li>
                <li><a href="#" class="nav-link" id="nav-outgoing" onclick="showPage('outgoing')"><i class="bi bi-box-arrow-up me-2"></i>出庫登録</a></li>
                <li><a href="#" class="nav-link" id="nav-history" onclick="showPage('history')"><i class="bi bi-clock-history me-2"></i>入出庫履歴</a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="nav-audit-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-clipboard2-check me-2"></i>棚卸
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="nav-audit-dropdown">
                        <li><a class="dropdown-item" href="#" id="nav-audit-registration" onclick="showPage('audit-registration')">棚卸登録</a></li>
                        <li><a class="dropdown-item" href="#" id="nav-audit-report" onclick="showPage('audit-report')">棚卸レポート</a></li>
                    </ul>
                </li>
            </ul>
            <hr>
            <ul class="nav nav-pills flex-column">
                <li><a href="#" class="nav-link" id="nav-manual" onclick="showPage('manual')"><i class="bi bi-question-circle-fill me-2"></i>使い方マニュアル</a></li>
                <li><a href="#" class="nav-link" id="nav-bug-report" onclick="showPage('bug-report')"><i class="bi bi-bug-fill me-2"></i>不具合を報告</a></li>
            </ul>
        </div>
    </div>

    <!-- Header -->
    <header class="header bg-light p-2 border-bottom sticky-top">
        <div class="container-fluid d-flex align-items-center">
            <button class="btn btn-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar">
                <i class="bi bi-list fs-4"></i>
            </button>
            <h1 class="h4 mb-0 ms-3" id="page-title-header"></h1>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <div id="global-nav-container" class="container-lg pt-3 pb-2"></div>
        <div id="page-container">
            <!-- Pages will be injected here by JavaScript -->
        </div>
    </main>

    <!-- Modals -->
    <div class="modal fade" id="editHistoryModal" tabindex="-1" aria-hidden="true"></div>
    <div class="modal fade" id="discrepancyDetailsModal" tabindex="-1" aria-hidden="true"></div>
    <div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="alertModalLabel">メッセージ</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="alertModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button></div></div></div></div>
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="confirmModalLabel">確認</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="confirmModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button><button type="button" class="btn btn-primary" id="confirmModalOk">OK</button></div></div></div></div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ===============================================================
        // グローバル変数・初期設定
        // ===============================================================
        const mainContent = document.getElementById('page-container');
        const loadingSpinner = document.getElementById('loading');
        let editHistoryModal, discrepancyDetailsModal, alertModal, confirmModal, sidebar;
        
        let allProducts = [];
        let auditRegistrationData = [];
        let lastReportData = [];

        // ===============================================================
        // ユーティリティ関数
        // ===============================================================
        const showLoading = () => loadingSpinner.style.display = 'flex';
        const hideLoading = () => loadingSpinner.style.display = 'none';
        function serverCall(functionName, ...args) { return new Promise((resolve, reject) => { google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)[functionName](...args); }); }
        function showAlert(message) { document.getElementById('alertModalBody').textContent = message; alertModal.show(); }
        
        function showConfirm(message) {
            return new Promise(resolve => {
                const confirmModalEl = document.getElementById('confirmModal');
                const okButton = document.getElementById('confirmModalOk');
                let isOkClicked = false;

                document.getElementById('confirmModalBody').textContent = message;

                const onOkClick = () => {
                    isOkClicked = true;
                    confirmModal.hide();
                };

                const onHide = () => {
                    resolve(isOkClicked);
                    okButton.removeEventListener('click', onOkClick);
                    confirmModalEl.removeEventListener('hidden.bs.modal', onHide);
                };

                okButton.addEventListener('click', onOkClick, { once: true });
                confirmModalEl.addEventListener('hidden.bs.modal', onHide, { once: true });

                confirmModal.show();
            });
        }

        // ===============================================================
        // 初期化・ページ表示ロジック
        // ===============================================================
        function initializeApp() {
            if (typeof google === 'undefined' || !google.script) { setTimeout(initializeApp, 100); return; }
            console.log("API ready.");
            sidebar = new bootstrap.Offcanvas(document.getElementById('sidebar'));
            editHistoryModal = new bootstrap.Modal(document.getElementById('editHistoryModal'));
            discrepancyDetailsModal = new bootstrap.Modal(document.getElementById('discrepancyDetailsModal'));
            alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
            confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            renderAllPages();
            loadInitialData();
            loadManual();
            showPage('home');
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const page = document.getElementById(`page-${pageId}`);
            if (page) page.classList.add('active');
            
            document.querySelectorAll('#sidebar .nav-link').forEach(link => link.classList.remove('active', 'show'));
            document.querySelectorAll('#sidebar .dropdown-menu .dropdown-item').forEach(link => link.classList.remove('active'));

            let activeLink = document.getElementById(`nav-${pageId}`);
            if (activeLink) {
                if(pageId.startsWith('audit-')) {
                    const dropdownToggle = document.getElementById('nav-audit-dropdown');
                    dropdownToggle.classList.add('active');
                    dropdownToggle.classList.add('show');
                    document.getElementById(`nav-${pageId}`).classList.add('active');
                } else {
                    activeLink.classList.add('active');
                }
                document.getElementById('page-title-header').textContent = activeLink.textContent.trim();
            }

            renderGlobalNav(pageId);

            if (sidebar) sidebar.hide();
        }

        // ===============================================================
        // データ取得・描画ロジック
        // ===============================================================
        async function loadInitialData() {
            showLoading();
            try {
                const [products, staff, stock, history] = await Promise.all([
                    serverCall('getProducts'), serverCall('getStaffList'),
                    serverCall('getStockSummary'), serverCall('getHistory', {})
                ]);
                allProducts = products;
                renderProductSelectors();
                renderStaffList(staff);
                renderStockSummary(stock);
                renderHistory(history);
            } catch (err) { showAlert('データの読み込み中にエラーが発生しました: ' + err.message); } 
            finally { hideLoading(); }
        }
        
        async function refreshData(target = 'all') {
            showLoading();
            try {
                if (target === 'all' || target === 'stock') {
                    const stock = await serverCall('getStockSummary');
                    renderStockSummary(stock);
                }
                if (target === 'all' || target === 'history') {
                    await applyHistoryFilter();
                }
            } catch (err) { showAlert('データの更新中にエラーが発生しました: ' + err.message); } 
            finally { hideLoading(); }
        }
        
        async function loadManual() { try { const manualHtml = await serverCall('getManualHtml'); document.getElementById('page-manual').innerHTML = manualHtml; } catch (err) { document.getElementById('page-manual').innerHTML = `<div class="alert alert-danger">マニュアルの読み込みに失敗しました。</div>`; } }
        
        function renderAllPages() {
            mainContent.innerHTML = `
                <!-- ホーム画面 -->
                <div class="page" id="page-home">
                    <div class="container-fluid p-3 p-md-4">
                        <div class="row align-items-md-stretch">
                            <div class="col-md-6 mb-4">
                                <div class="home-button-wrapper bg-pastel-green" onclick="showPage('incoming')">
                                    <button class="btn home-button"><i class="bi bi-box-arrow-in-down me-2"></i>入庫を登録する</button>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="home-button-wrapper bg-pastel-orange" onclick="showPage('outgoing')">
                                    <button class="btn home-button"><i class="bi bi-box-arrow-up me-2"></i>出庫を登録する</button>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="home-button-wrapper bg-pastel-blue" onclick="showPage('stock')">
                                    <button class="btn home-button"><i class="bi bi-table me-2"></i>現在の在庫を確認</button>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="home-button-wrapper bg-pastel-purple" onclick="showPage('audit-registration')">
                                    <button class="btn home-button"><i class="bi bi-clipboard2-check me-2"></i>棚卸を行う</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 在庫一覧画面 -->
                <div class="page" id="page-stock">
                    <div class="container-lg p-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                在庫一覧
                                <button class="btn btn-sm btn-outline-secondary" onclick="refreshData('stock')"><i class="bi bi-arrow-clockwise"></i> 更新</button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>製品名</th>
                                                <th>現在在庫数</th>
                                                <th>最終更新日時</th>
                                                <th>最終棚卸日</th>
                                            </tr>
                                        </thead>
                                        <tbody id="stock-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 入庫登録画面 -->
                <div class="page" id="page-incoming">
                    <div class="container-lg p-4">
                        <div class="card">
                            <div class="card-header">入庫情報の入力</div>
                            <div class="card-body">
                                <form id="incoming-form">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="incoming-cat1" class="form-label">大分類</label>
                                            <select class="form-select" id="incoming-cat1" onchange="updateProductSubSelectors('incoming')"></select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="incoming-cat2" class="form-label">中分類</label>
                                            <select class="form-select" id="incoming-cat2" onchange="updateProductSubSelectors('incoming')"></select>
                                        </div>
                                    </div>
                                    <div class="mb-3 mt-3">
                                        <label for="incoming-product" class="form-label">製品名</label>
                                        <select class="form-select" id="incoming-product" required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="incoming-quantity" class="form-label">数量</label>
                                        <input type="number" class="form-control" id="incoming-quantity" min="1" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="incoming-staff" class="form-label">担当者名</label>
                                        <select class="form-select" id="incoming-staff" required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="incoming-remarks" class="form-label">備考</label>
                                        <textarea class="form-control" id="incoming-remarks" rows="2"></textarea>
                                    </div>
                                    <button type="button" class="btn btn-primary w-100" onclick="submitTransaction('入庫')">登録する</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 出庫登録画面 -->
                <div class="page" id="page-outgoing">
                    <div class="container-lg p-4">
                        <div class="card">
                            <div class="card-header">出庫情報の入力</div>
                            <div class="card-body">
                                <form id="outgoing-form">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="outgoing-cat1" class="form-label">大分類</label>
                                            <select class="form-select" id="outgoing-cat1" onchange="updateProductSubSelectors('outgoing')"></select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="outgoing-cat2" class="form-label">中分類</label>
                                            <select class="form-select" id="outgoing-cat2" onchange="updateProductSubSelectors('outgoing')"></select>
                                        </div>
                                    </div>
                                    <div class="mb-3 mt-3">
                                        <label for="outgoing-product" class="form-label">製品名</label>
                                        <select class="form-select" id="outgoing-product" required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="outgoing-quantity" class="form-label">数量</label>
                                        <input type="number" class="form-control" id="outgoing-quantity" min="1" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="outgoing-staff" class="form-label">担当者名</label>
                                        <select class="form-select" id="outgoing-staff" required></select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="outgoing-site" class="form-label">使用現場・号地</label>
                                        <input type="text" class="form-control" id="outgoing-site">
                                    </div>
                                    <div class="mb-3">
                                        <label for="outgoing-remarks" class="form-label">備考</label>
                                        <textarea class="form-control" id="outgoing-remarks" rows="2"></textarea>
                                    </div>
                                    <button type="button" class="btn btn-warning w-100" onclick="submitTransaction('出庫')">登録する</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 入出庫履歴画面 -->
                <div class="page" id="page-history">
                    <div class="container-lg p-4">
                        <div class="card">
                            <div class="card-header">入出庫履歴</div>
                            <div class="card-body">
                                <div class="accordion mb-3" id="filterAccordion">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="filter-heading">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#filter-collapse" aria-expanded="false" aria-controls="filter-collapse">
                                                <i class="bi bi-funnel me-2"></i>フィルターで絞り込み
                                            </button>
                                        </h2>
                                        <div id="filter-collapse" class="accordion-collapse collapse" aria-labelledby="filter-heading" data-bs-parent="#filterAccordion">
                                            <div class="accordion-body">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label for="filter-cat1" class="form-label">大分類</label>
                                                        <select class="form-select form-select-sm" id="filter-cat1" onchange="updateProductSubSelectors('filter')"></select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label for="filter-cat2" class="form-label">中分類</label>
                                                        <select class="form-select form-select-sm" id="filter-cat2" onchange="updateProductSubSelectors('filter')"></select>
                                                    </div>
                                                    <div class="col-md-6 col-lg-3">
                                                        <label for="filter-product" class="form-label">製品名</label>
                                                        <select class="form-select form-select-sm" id="filter-product"></select>
                                                    </div>
                                                    <div class="col-md-6 col-lg-3">
                                                        <label for="filter-staff" class="form-label">担当者</label>
                                                        <input type="text" class="form-control form-control-sm" id="filter-staff">
                                                    </div>
                                                    <div class="col-md-6 col-lg-2">
                                                        <label for="filter-type" class="form-label">種別</label>
                                                        <select class="form-select form-select-sm" id="filter-type">
                                                            <option value="">すべて</option>
                                                            <option value="入庫">入庫</option>
                                                            <option value="出庫">出庫</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6 col-lg-4">
                                                        <label class="form-label">期間</label>
                                                        <div class="input-group input-group-sm">
                                                            <input type="date" class="form-control" id="filter-start-date">
                                                            <span class="input-group-text">～</span>
                                                            <input type="date" class="form-control" id="filter-end-date">
                                                        </div>
                                                    </div>
                                                    <div class="col-12 text-end">
                                                        <button class="btn btn-sm btn-secondary me-2" onclick="clearHistoryFilter()"><i class="bi bi-x-lg me-1"></i>クリア</button>
                                                        <button class="btn btn-sm btn-primary" onclick="applyHistoryFilter()"><i class="bi bi-search me-1"></i>フィルター適用</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>日時</th>
                                                <th>種別</th>
                                                <th>製品名</th>
                                                <th>数量</th>
                                                <th>担当者</th>
                                                <th>現場・号地</th>
                                                <th>備考</th>
                                                <th class="text-center">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="history-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 棚卸登録画面 -->
                <div class="page" id="page-audit-registration">
                    <div class="container-lg p-4">
                        <div class="card">
                            <div class="card-header">棚卸登録</div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle-fill me-2"></i>実在庫数を入力し、「進捗を保存」ボタンで一時保存できます。すべての入力が終わったら「棚卸レポート」画面で内容を確認し、在庫数を確定してください。
                                </div>
                                <div class="row g-3 mb-3 align-items-end">
                                    <div class="col-md-4">
                                        <label for="audit-reg-cat1" class="form-label">大分類</label>
                                        <select class="form-select" id="audit-reg-cat1" onchange="updateProductSubSelectors('audit-reg'); applyAuditRegistrationFilter();"></select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="audit-reg-cat2" class="form-label">中分類</label>
                                        <select class="form-select" id="audit-reg-cat2" onchange="applyAuditRegistrationFilter()"></select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="audit-reg-search" class="form-label">製品名検索</label>
                                        <input type="text" class="form-control" id="audit-reg-search" oninput="applyAuditRegistrationFilter()">
                                    </div>
                                    <div class="col-12 text-end">
                                        <button class="btn btn-sm btn-secondary me-2" onclick="clearAuditRegistrationFilter()"><i class="bi bi-x-lg me-1"></i>クリア</button>
                                        <button class="btn btn-sm btn-primary" onclick="applyAuditRegistrationFilter()"><i class="bi bi-search me-1"></i>フィルター適用</button>
                                    </div>
                                </div>
                                <div class="table-responsive mb-3" style="max-height: 50vh;">
                                    <table class="table table-sm table-bordered table-hover">
                                        <thead>
                                            <tr class="table-light">
                                                <th>製品名</th>
                                                <th>大分類</th>
                                                <th>中分類</th>
                                                <th style="width: 120px;">実在庫数</th>
                                            </tr>
                                        </thead>
                                        <tbody id="audit-reg-table-body"></tbody>
                                    </table>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="audit-reg-auditor" class="form-label">棚卸担当者名</label>
                                        <input type="text" class="form-control" id="audit-reg-auditor">
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button class="btn btn-primary w-100" onclick="saveAuditStaging()"><i class="bi bi-save-fill me-1"></i>進捗を保存</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 棚卸レポート画面 -->
                <div class="page" id="page-audit-report">
                    <div class="container-lg p-4">
                        <div class="card">
                            <div class="card-header">棚卸レポート</div>
                            <div class="card-body">
                                <div class="row g-3 align-items-end mb-3">
                                    <div class="col-md-5">
                                        <label for="report-start-date" class="form-label">対象期間（開始）</label>
                                        <input type="date" id="report-start-date" class="form-control">
                                    </div>
                                    <div class="col-md-5">
                                        <label for="report-end-date" class="form-label">対象期間（終了）</label>
                                        <input type="date" id="report-end-date" class="form-control">
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-info w-100" onclick="generateReport()"><i class="bi bi-calculator me-1"></i>生成</button>
                                    </div>
                                </div>
                                <div id="report-area" class="d-none">
                                    <div class="table-responsive" id="report-table-container"></div>
                                    <div class="mt-3 p-3 border rounded">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="auditor-name-report" class="form-label">棚卸担当者名</label>
                                                <input type="text" class="form-control" id="auditor-name-report" placeholder="氏名を入力">
                                            </div>
                                            <div class="col-md-6 d-flex align-items-end mb-3">
                                                <div class="d-grid gap-2 w-100">
                                                    <button class="btn btn-danger" onclick="handlePdfOutput('download')"><i class="bi bi-file-earmark-pdf-fill me-1"></i>PDF保存</button>
                                                    <button class="btn btn-success" onclick="finalizeInventory()"><i class="bi bi-check-circle-fill me-1"></i>この内容で棚卸を確定する</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- その他のページ -->
                <div class="page" id="page-bug-report"></div>
                <div class="page" id="page-manual"></div>
            `;
            document.getElementById('editHistoryModal').innerHTML = `<div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">履歴の編集</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><input type="hidden" id="edit-log-id"><div class="mb-3"><label class="form-label">日時</label><input type="datetime-local" class="form-control" id="edit-timestamp"></div><div class="mb-3"><label class="form-label">種別</label><select class="form-select" id="edit-type"><option value="入庫">入庫</option><option value="出庫">出庫</option></select></div><div class="mb-3"><label class="form-label">製品名</label><select class="form-select" id="edit-product"></select></div><div class="mb-3"><label class="form-label">数量</label><input type="number" class="form-control" id="edit-quantity" min="1"></div><div class="mb-3"><label class="form-label">担当者名</label><input type="text" class="form-control" id="edit-staff"></div><div class="mb-3"><label class="form-label">使用現場・号地</label><input type="text" class="form-control" id="edit-site"></div><div class="mb-3"><label class="form-label">備考</label><textarea class="form-control" id="edit-remarks" rows="2"></textarea></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button><button type="button" class="btn btn-primary" onclick="saveHistoryChanges()">変更を保存</button></div></div></div>`;
            document.getElementById('discrepancyDetailsModal').innerHTML = `<div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="discrepancyModalLabel">出庫詳細</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body" id="discrepancyModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button></div></div></div>`;
            const today = new Date(); const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1); document.getElementById('report-start-date').valueAsDate = firstDayOfMonth; document.getElementById('report-end-date').valueAsDate = today;
        }

        function renderProductSelectors(formTypePrefix = null) {
            const prefixes = formTypePrefix ? [formTypePrefix] : ['incoming', 'outgoing', 'filter', 'audit-reg'];
            const uniqueCat1s = [...new Set(allProducts.map(p => p.category1))];
            const cat1Html = '<option value="">すべて選択</option>' + uniqueCat1s.map(c => `<option value="${c}">${c}</option>`).join('');

            prefixes.forEach(prefix => {
                const cat1Select = document.getElementById(`${prefix}-cat1`);
                if (cat1Select) cat1Select.innerHTML = cat1Html;
                updateProductSubSelectors(prefix);
            });
            const productFilterSelect = document.getElementById('filter-product');
            if(productFilterSelect) productFilterSelect.innerHTML = '<option value="">すべて</option>' + allProducts.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            const editProductSelect = document.getElementById('edit-product');
            if(editProductSelect) editProductSelect.innerHTML = '<option value="">選択してください</option>' + allProducts.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
        }

        function updateProductSubSelectors(prefix) {
            const cat1Select = document.getElementById(`${prefix}-cat1`);
            const cat2Select = document.getElementById(`${prefix}-cat2`);
            const productSelect = document.getElementById(`${prefix}-product`);

            const selectedCat1 = cat1Select ? cat1Select.value : '';
            const selectedCat2 = cat2Select ? cat2Select.value : '';

            if (cat2Select) {
                const currentCat2Value = cat2Select.value;
                const availableCat2s = [...new Set(allProducts.filter(p => !selectedCat1 || p.category1 === selectedCat1).map(p => p.category2))];
                cat2Select.innerHTML = '<option value="">すべて選択</option>' + availableCat2s.map(c => `<option value="${c}" ${c === currentCat2Value ? 'selected' : ''}>${c}</option>`).join('');
            }
            if (productSelect) {
                const currentProductValue = productSelect.value;
                let filteredProducts = allProducts;
                if (selectedCat1) filteredProducts = filteredProducts.filter(p => p.category1 === selectedCat1);
                if (selectedCat2) filteredProducts = filteredProducts.filter(p => p.category2 === selectedCat2);
                const firstOption = prefix === 'filter' ? '<option value="">すべて</option>' : '<option value="">選択してください</option>';
                productSelect.innerHTML = firstOption + filteredProducts.map(p => `<option value="${p.name}" ${p.name === currentProductValue ? 'selected' : ''}>${p.name}</option>`).join('');
            }
        }

        function renderStaffList(staff) {
            const selects = [document.getElementById('incoming-staff'), document.getElementById('outgoing-staff')];
            const options = '<option value="">選択してください</option>' + staff.map(s => `<option value="${s}">${s}</option>`).join('');
            selects.forEach(s => { if(s) s.innerHTML = options; });
        }

        function renderStockSummary(data) {
            const tbody = document.getElementById('stock-table-body');
            if(!tbody) return;
            tbody.innerHTML = !data || data.length === 0 ? '<tr><td colspan="4" class="text-center">在庫データがありません。</td></tr>' : 
                data.map(item => `<tr><td>${item.product_name}</td><td>${item.current_stock}</td><td>${item.last_updated ? new Date(item.last_updated).toLocaleString('ja-JP') : '---'}</td><td>${item.last_audited ? new Date(item.last_audited).toLocaleString('ja-JP') : '---'}</td></tr>`).join('');
        }

        function renderHistory(data) {
            const tbody = document.getElementById('history-table-body');
            if(!tbody) return;
            tbody.innerHTML = !data || data.length === 0 ? '<tr><td colspan="8" class="text-center">履歴データがありません。</td></tr>' : data.map(item => { const itemJson = JSON.stringify(item).replace(/"/g, '&quot;'); const badge = item.transaction_type === '入庫' ? '<span class="badge bg-primary">入庫</span>' : '<span class="badge bg-warning text-dark">出庫</span>'; return `<tr><td>${new Date(item.timestamp).toLocaleString('ja-JP')}</td><td>${badge}</td><td>${item.product_name}</td><td>${item.quantity}</td><td>${item.staff_name}</td><td>${item.site_name || ''}</td><td>${item.remarks || ''}</td><td class="text-center action-buttons"><button class="btn btn-sm btn-outline-primary me-2" onclick='openEditModal(${itemJson})'><i class="bi bi-pencil"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteHistory(${item.log_id})"><i class="bi bi-trash"></i></button></td></tr>`; }).join('');
        }
        
        function renderGlobalNav(currentPageId) {
            const navContainer = document.getElementById('global-nav-container');
            if (!navContainer) return;

            if (['home', 'manual', 'bug-report'].includes(currentPageId)) {
                navContainer.innerHTML = '';
                return;
            }

            const pages = [
                { id: 'home', icon: 'house-door-fill', label: 'ホーム' },
                { id: 'stock', icon: 'table', label: '在庫一覧' },
                { id: 'incoming', icon: 'box-arrow-in-down', label: '入庫登録' },
                { id: 'outgoing', icon: 'box-arrow-up', label: '出庫登録' },
                { id: 'history', icon: 'clock-history', label: '入出庫履歴' },
                { id: 'audit-registration', icon: 'clipboard2-check', label: '棚卸登録' },
                { id: 'audit-report', icon: 'clipboard2-data', label: '棚卸レポート' }
            ];

            const buttonsHtml = pages
                .filter(page => page.id !== currentPageId)
                .map(page => `
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="showPage('${page.id}')">
                        <i class="bi bi-${page.icon} me-1"></i>${page.label}
                    </button>
                `).join('');
            
            navContainer.innerHTML = `<div class="d-flex flex-wrap gap-2">${buttonsHtml}</div>`;
        }

        // ===============================================================
        // 棚卸登録画面関連の関数
        // ===============================================================
        async function loadAuditRegistrationData() {
            showLoading();
            try {
                auditRegistrationData = await serverCall('getAuditRegistrationData');
                renderProductSelectors('audit-reg');
                applyAuditRegistrationFilter();
            } catch (err) {
                showAlert('棚卸登録画面のデータ取得に失敗しました: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        function applyAuditRegistrationFilter() {
            const cat1 = document.getElementById('audit-reg-cat1').value;
            const cat2 = document.getElementById('audit-reg-cat2').value;
            const searchTerm = document.getElementById('audit-reg-search').value.toLowerCase();
            
            const filtered = auditRegistrationData.filter(item => {
                const matchCat1 = !cat1 || item.category1 === cat1;
                const matchCat2 = !cat2 || item.category2 === cat2;
                const matchSearch = !searchTerm || item.productName.toLowerCase().includes(searchTerm);
                return matchCat1 && matchCat2 && matchSearch;
            });
            renderAuditRegistrationTable(filtered);
        }

        function clearAuditRegistrationFilter() {
            document.getElementById('audit-reg-cat1').value = '';
            document.getElementById('audit-reg-cat2').value = '';
            document.getElementById('audit-reg-search').value = '';
            applyAuditRegistrationFilter();
        }

        function renderAuditRegistrationTable(data) {
            const tbody = document.getElementById('audit-reg-table-body');
            if (!tbody) return;
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${item.productName}</td>
                    <td>${item.category1}</td>
                    <td>${item.category2}</td>
                    <td><input type="number" class="form-control form-control-sm audit-stock-input" data-product-name="${item.productName}" value="${item.actualStock || ''}" min="0"></td>
                </tr>
            `).join('');
        }

        async function saveAuditStaging() {
            const auditorName = document.getElementById('audit-reg-auditor').value;
            if (!auditorName) {
                showAlert('棚卸担当者名を入力してください。');
                return;
            }
            
            const dataToSave = [];
            document.querySelectorAll('.audit-stock-input').forEach(input => {
                if (input.value !== '') {
                    dataToSave.push({
                        productName: input.dataset.productName,
                        actualStock: parseInt(input.value, 10),
                        auditorName: auditorName
                    });
                }
            });

            if (dataToSave.length === 0) {
                showAlert('保存するデータが入力されていません。');
                return;
            }
            if (!await showConfirm('入力された実在庫数を一時保存します。よろしいですか？')) return;

            showLoading();
            try {
                const response = await serverCall('saveAuditStagingData', dataToSave);
                showAlert(response);
                await loadAuditRegistrationData();
            } catch (err) {
                showAlert('保存に失敗しました: ' + err.message);
            } finally {
                hideLoading();
            }
        }

        // ===============================================================
        // イベントハンドラ・アクション関数
        // ===============================================================
        async function submitTransaction(type) {
            const formId = type === '入庫' ? 'incoming' : 'outgoing';
            const product = document.getElementById(`${formId}-product`).value;
            const quantity = document.getElementById(`${formId}-quantity`).value;
            const staff = document.getElementById(`${formId}-staff`).value;
            const site = (type === '出庫') ? document.getElementById(`${formId}-site`).value : '';
            const remarks = document.getElementById(`${formId}-remarks`).value;
            if (!product || !quantity || !staff) { showAlert('製品名、数量、担当者名は必須です。'); return; }
            showLoading();
            try {
                const response = await serverCall('recordTransaction', type, product, parseInt(quantity), staff, site, remarks);
                showAlert(response);
                document.getElementById(`${formId}-form`).reset();
                updateProductSubSelectors(formId);
                await refreshData('stock');
            } catch (err) { showAlert('登録に失敗しました: ' + err.message); } 
            finally { hideLoading(); }
        }

        function openEditModal(item) {
            document.getElementById('edit-log-id').value = item.log_id;
            const dt = new Date(item.timestamp);
            dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
            document.getElementById('edit-timestamp').value = dt.toISOString().slice(0,16);
            document.getElementById('edit-type').value = item.transaction_type;
            document.getElementById('edit-product').value = item.product_name;
            document.getElementById('edit-quantity').value = item.quantity;
            document.getElementById('edit-staff').value = item.staff_name;
            document.getElementById('edit-site').value = item.site_name;
            document.getElementById('edit-remarks').value = item.remarks;
            editHistoryModal.show();
        }
        async function saveHistoryChanges() {
            const updatedData = {
                log_id: document.getElementById('edit-log-id').value,
                timestamp: new Date(document.getElementById('edit-timestamp').value).toISOString(),
                transaction_type: document.getElementById('edit-type').value,
                product_name: document.getElementById('edit-product').value,
                quantity: parseInt(document.getElementById('edit-quantity').value),
                staff_name: document.getElementById('edit-staff').value,
                site_name: document.getElementById('edit-site').value,
                remarks: document.getElementById('edit-remarks').value,
            };
            if (!updatedData.product_name || !updatedData.quantity || !updatedData.staff_name) { showAlert('製品名、数量、担当者名は必須です。'); return; }
            showLoading();
            try {
                const response = await serverCall('updateTransaction', updatedData);
                showAlert(response);
                editHistoryModal.hide();
                await refreshData();
            } catch (err) { showAlert('更新に失敗しました: ' + err.message); }
            finally { hideLoading(); }
        }
        async function deleteHistory(logId) {
            if (!await showConfirm('この履歴を削除します。在庫数も自動で再計算されます。よろしいですか？')) return;
            showLoading();
            try {
                const response = await serverCall('deleteTransaction', logId);
                showAlert(response);
                await refreshData();
            } catch (err) { showAlert('削除に失敗しました: ' + err.message); }
            finally { hideLoading(); }
        }

        async function generateReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            if (!startDate || !endDate) { showAlert('対象期間の開始日と終了日を選択してください。'); return; }
            if (new Date(startDate) > new Date(endDate)) { showAlert('開始日は終了日より前の日付を選択してください。'); return; }
            showLoading();
            try {
                lastReportData = await serverCall('getInventoryReportByDateRange', startDate, endDate);
                renderReport(lastReportData);
                document.getElementById('report-area').classList.remove('d-none');
            } catch (err) { showAlert('レポートの生成に失敗しました: ' + err.message); } 
            finally { hideLoading(); }
        }

        function renderReport(data) {
            let tableHtml = `<table class="table table-bordered table-sm"><thead class="table-light text-center"><tr><th rowspan="2">製品名</th><th rowspan="2">単価</th><th colspan="2">期間開始在庫</th><th colspan="2">期間中入庫</th><th colspan="2">期間中出庫</th><th colspan="2">理論在庫</th><th colspan="2">実在庫</th><th colspan="3">差異</th></tr><tr><th>数量</th><th>金額</th><th>数量</th><th>金額</th><th>数量</th><th>金額</th><th>数量</th><th>金額</th><th>数量</th><th>金額</th><th>数量</th><th>金額</th><th>詳細</th></tr></thead><tbody>`;
            let totals = { startValue: 0, inValue: 0, outValue: 0, theoreticalValue: 0, actualValue: 0, diffValue: 0 };
            
            data.forEach((item, index) => {
                const startValue = item.periodStartStock * item.unitPrice;
                const inValue = item.periodIncoming * item.unitPrice;
                const outValue = item.periodOutgoing * item.unitPrice;
                const theoreticalValue = item.theoreticalStock * item.unitPrice;
                const actualStock = item.actualStock !== null ? item.actualStock : '---';
                const actualValue = item.actualStock !== null ? item.actualStock * item.unitPrice : null;
                const differenceQty = item.actualStock !== null ? item.actualStock - item.theoreticalStock : null;
                
                totals.startValue += startValue;
                totals.inValue += inValue;
                totals.outValue += outValue;
                totals.theoreticalValue += theoreticalValue;
                if (actualValue !== null) totals.actualValue += actualValue;
                if (differenceQty !== null) totals.diffValue += differenceQty * item.unitPrice;

                tableHtml += `<tr>
                    <td>${item.productName}</td><td class="text-end">${item.unitPrice.toLocaleString()}円</td>
                    <td class="text-end">${item.periodStartStock}</td><td class="text-end">${startValue.toLocaleString()}円</td>
                    <td class="text-end">${item.periodIncoming}</td><td class="text-end">${inValue.toLocaleString()}円</td>
                    <td class="text-end">${item.periodOutgoing}</td><td class="text-end">${outValue.toLocaleString()}円</td>
                    <td class="text-end">${item.theoreticalStock}</td><td class="text-end">${theoreticalValue.toLocaleString()}円</td>
                    <td class="text-end">${actualStock}</td><td class="text-end">${actualValue !== null ? actualValue.toLocaleString() + '円' : '---'}</td>
                    <td class="text-end ${differenceQty > 0 ? 'diff-plus' : differenceQty < 0 ? 'diff-minus' : ''}">${differenceQty !== null ? differenceQty : '---'}</td>
                    <td class="text-end">${differenceQty !== null ? (differenceQty * item.unitPrice).toLocaleString() + '円' : '---'}</td>
                    <td class="text-center">${differenceQty !== 0 && differenceQty !== null ? `<button class="btn btn-sm btn-outline-info" onclick="showDiscrepancyDetails(${index})"><i class="bi bi-search"></i></button>` : ''}</td>
                </tr>`;
            });
            tableHtml += `</tbody><tfoot class="table-dark"><tr><th colspan="3" class="text-end">合計</th><th class="text-end">${totals.startValue.toLocaleString()}円</th><th></th><th class="text-end">${totals.inValue.toLocaleString()}円</th><th></th><th class="text-end">${totals.outValue.toLocaleString()}円</th><th></th><th class="text-end">${totals.theoreticalValue.toLocaleString()}円</th><th></th><th class="text-end">${totals.actualValue.toLocaleString()}円</th><th colspan="2" class="text-end">${totals.diffValue.toLocaleString()}円</th><th></th></tr></tfoot></table>`;
            document.getElementById('report-table-container').innerHTML = tableHtml;
        }

        function showDiscrepancyDetails(index) {
            const productData = lastReportData[index];
            const modalTitle = document.getElementById('discrepancyModalLabel');
            const modalBody = document.getElementById('discrepancyModalBody');
            modalTitle.textContent = `${productData.productName} - 期間中出庫詳細`;
            if (!productData.outgoingDetails || productData.outgoingDetails.length === 0) {
                modalBody.innerHTML = '<p>この期間の出庫履歴はありません。</p>';
            } else {
                let tableHtml = '<table class="table table-sm table-bordered"><thead><tr><th>日時</th><th>担当者</th><th>現場</th><th>数量</th></tr></thead><tbody>';
                productData.outgoingDetails.forEach(detail => {
                    tableHtml += `<tr><td>${new Date(detail.date).toLocaleString('ja-JP')}</td><td>${detail.staff || ''}</td><td>${detail.site || ''}</td><td class="text-end">${detail.quantity}</td></tr>`;
                });
                tableHtml += '</tbody></table>';
                modalBody.innerHTML = tableHtml;
            }
            discrepancyDetailsModal.show();
        }
        
        async function handlePdfOutput(mode) {
            const reportContainer = document.getElementById('report-table-container');
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            if (!reportContainer || reportContainer.innerHTML.trim() === '') {
                showAlert('先にレポートを生成してください。');
                return;
            }
            const htmlContent = `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><style>body { font-family: "Helvetica", "Arial", sans-serif; } table { border-collapse: collapse; width: 100%; font-size: 10px; } th, td { border: 1px solid #ccc; padding: 4px; text-align: right; } th { background-color: #f2f2f2; text-align: center; } h1 { font-size: 18px; }</style></head><body><h1>棚卸レポート (${startDate} ~ ${endDate})</h1>${reportContainer.innerHTML}</body></html>`;
            
            showLoading();
            try {
                const base64Pdf = await serverCall('generatePdf', htmlContent);
                const dataUri = `data:application/pdf;base64,${base64Pdf}`;
                if (mode === 'preview') {
                    window.open(dataUri, '_blank');
                } else {
                    const link = document.createElement('a');
                    link.href = dataUri;
                    link.download = `棚卸レポート_${startDate}_${endDate}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            } catch (err) { showAlert('PDFの出力に失敗しました: ' + err.message); }
            finally { hideLoading(); }
        }

        async function finalizeInventory() {
            const auditorName = document.getElementById('auditor-name-report').value;
            if (!auditorName) { showAlert('棚卸担当者名を入力してください。'); return; }
            if (!await showConfirm('この内容で棚卸を確定し、現在の在庫数を更新します。この操作は元に戻せません。よろしいですか？')) return;
            showLoading();
            try {
                const response = await serverCall('finalizeInventory', auditorName);
                showAlert(response);
                document.getElementById('report-area').classList.add('d-none');
                await refreshData();
            } catch(err) { showAlert('棚卸の確定に失敗しました: ' + err.message); }
            finally { hideLoading(); }
        }

        async function applyHistoryFilter() {
            const filters = {
                category1: document.getElementById('filter-cat1').value,
                category2: document.getElementById('filter-cat2').value,
                productName: document.getElementById('filter-product').value,
                staffName: document.getElementById('filter-staff').value,
                transactionType: document.getElementById('filter-type').value,
                startDate: document.getElementById('filter-start-date').value,
                endDate: document.getElementById('filter-end-date').value,
            };
            showLoading();
            try {
                const history = await serverCall('getHistory', filters);
                renderHistory(history);
            } catch (err) { showAlert('履歴のフィルター適用に失敗しました: ' + err.message); }
            finally { hideLoading(); }
        }

        function clearHistoryFilter() {
            ['filter-cat1', 'filter-cat2', 'filter-product', 'filter-staff', 'filter-type', 'filter-start-date', 'filter-end-date'].forEach(id => document.getElementById(id).value = '');
            applyHistoryFilter();
        }

        async function submitBugReport() {
            const report = {
                reporterName: document.getElementById('bug-reporter-name').value,
                occurrenceDate: document.getElementById('bug-occurrence-date').value,
                problemPage: document.getElementById('bug-problem-page').value,
                description: document.getElementById('bug-description').value,
            };
            if (!report.reporterName || !report.occurrenceDate || !report.problemPage || !report.description) { showAlert('すべての項目を入力してください。'); return; }
            if (!await showConfirm('この内容で不具合を報告します。よろしいですか？')) return;
            showLoading();
            try {
                const response = await serverCall('submitBugReport', report);
                showAlert(response);
                document.getElementById('bug-report-form').reset();
            } catch (err) { showAlert('報告の送信に失敗しました: ' + err.message); }
            finally { hideLoading(); }
        }

        // 特定のページを表示したときに追加のデータを読み込む
        document.body.addEventListener('click', (e) => {
            const anchor = e.target.closest('a[onclick*="showPage"], button[onclick*="showPage"]');
            if (anchor) {
                const pageId = anchor.getAttribute('onclick').match(/'(.*?)'/)[1];
                if (pageId === 'audit-registration') {
                    loadAuditRegistrationData();
                }
            }
        });

        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
